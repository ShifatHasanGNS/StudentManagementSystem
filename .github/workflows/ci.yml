name: CI

on:
    push:
        branches: [main, feature]
    pull_request:
        branches: [main]

jobs:
    build-and-test:
        name: Build & Test
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:15-alpine
                env:
                    POSTGRES_DB: studentdb
                    POSTGRES_USER: admin
                    POSTGRES_PASSWORD: admin123
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 25
              uses: actions/setup-java@v4
              with:
                  java-version: "25"
                  distribution: "temurin"
                  cache: maven

            - name: Run unit tests
              run: mvn test -Dspring.profiles.active=test -pl . -Dtest="*ServiceTest,*ServiceImplTest" --no-transfer-progress

            - name: Run integration tests
              env:
                  SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/studentdb
                  SPRING_DATASOURCE_USERNAME: admin
                  SPRING_DATASOURCE_PASSWORD: admin123
                  SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
              run: mvn test -Dspring.profiles.active=test -Dtest="*IntegrationTest" --no-transfer-progress

            - name: Build JAR (skip tests â€” already ran)
              run: mvn package -DskipTests --no-transfer-progress

            - name: Upload test reports
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: surefire-reports
                  path: target/surefire-reports/
                  retention-days: 7

            - name: Upload JAR artifact
              if: success()
              uses: actions/upload-artifact@v4
              with:
                  name: app-jar
                  path: target/*.jar
                  retention-days: 7

    docker-build:
        name: Docker Build Check
        runs-on: ubuntu-latest
        needs: build-and-test
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Build Docker image
              run: docker build -t student-management-app:${{ github.sha }} .
